# AmneziaWG Installer: Дополнительная информация и настройки

Это дополнение к основному [README.md](README.md), содержащее более глубокие технические детали, пояснения и продвинутые опции для скриптов установки и управления AmneziaWG.

## Оглавление

- [Детали конфигурации клиента](#детали-конфигурации-клиента)
  - [AllowedIPs](#allowedips-1)
  - [PersistentKeepalive](#persistentkeepalive-1)
  - [DNS](#dns-1)
  - [Изменение настроек по умолчанию](#изменение-настроек-по-умолчанию-1)
- [Настройки безопасности сервера](#настройки-безопасности-сервера)
  - [Фаервол UFW](#фаервол-ufw-1)
  - [Параметры ядра (Sysctl)](#параметры-ядра-sysctl-1)
  - [Fail2Ban (Ручная установка)](#fail2ban-ручная-установка-1)
- [Автоматизация обслуживания](#автоматизация-обслуживания)
  - [Резервное копирование](#резервное-копирование-1)
  - [Автоматические обновления](#автоматические-обновления-1)
  - [Ротация логов](#ротация-логов-1)
- [Параметры запуска скриптов](#параметры-запуска-скриптов)
  - [install_amneziawg.sh](#install_amneziawgsh-1)
  - [manage_amneziawg.sh](#manage_amneziawgsh-1)
- [Полный список команд управления](#полный-список-команд-управления-1)
- [Технические детали](#технические-детали)
  - [DKMS](#dkms-1)
  - [Python Venv](#python-venv-1)
  - [awgcfg.py](#awgcfgpy-1)
- [Диагностика и деинсталляция](#диагностика-и-деинсталляция)
- [Внесение вклада (Contributing)](#внесение-вклада-contributing)
- [Благодарности](#благодарности)

---

## Детали конфигурации клиента

Скрипт установки автоматически применяет следующие настройки к файлу-шаблону клиента (`/root/awg/_defclient.config`) перед генерацией файлов `.conf` для конкретных пользователей.

### AllowedIPs

Этот параметр определяет, какой трафик **клиент** должен направлять **в VPN-туннель**. Скрипт предлагает три режима при установке (или через CLI):

1.  **Режим 1: Весь трафик (`0.0.0.0/0`)**
    * **Описание:** Весь IPv4 трафик клиента (кроме специфических маршрутов ОС) будет идти через VPN.
    * **Плюсы:** Максимальная приватность и безопасность, весь трафик маскируется IP-адресом сервера.
    * **Минусы:** Может блокировать доступ к ресурсам локальной сети клиента (принтеры, другие компьютеры, NAS).
    * **Когда использовать:** Если нужна максимальная анонимность и весь трафик должен идти через сервер.

2.  **Режим 2: Список Amnezia + DNS (По умолчанию)**
    * **Описание:** Используется длинный список публичных IP-диапазонов, предложенный разработчиками AmneziaWG, плюс IP-адреса DNS-серверов Google (`8.8.8.8/32`) и Cloudflare (`1.1.1.1/32`).
        ```
        0.0.0.0/5, 8.0.0.0/7, 11.0.0.0/8, 12.0.0.0/6, 16.0.0.0/4, 32.0.0.0/3, 64.0.0.0/2, 128.0.0.0/3, 160.0.0.0/5, 168.0.0.0/6, 172.0.0.0/12, 172.32.0.0/11, 172.64.0.0/10, 172.128.0.0/9, 173.0.0.0/8, 174.0.0.0/7, 176.0.0.0/4, 192.0.0.0/9, 192.128.0.0/11, 192.160.0.0/13, 192.169.0.0/16, 192.170.0.0/15, 192.172.0.0/14, 192.176.0.0/12, 192.192.0.0/10, 193.0.0.0/8, 194.0.0.0/7, 196.0.0.0/6, 200.0.0.0/5, 208.0.0.0/4, 8.8.8.8/32, 1.1.1.1/32
        ```
    * **Предполагаемая цель:** Усложнение детекции VPN-трафика системами DPI (Deep Packet Inspection) и потенциальное улучшение совместимости в сетях с ограничениями. Явное указание DNS-серверов (`/32`) гарантирует, что запросы к ним пойдут через туннель.
    * **Плюсы:** Потенциально более устойчив к блокировкам, гарантирует туннелирование DNS.
    * **Минусы:** Не исключает локальную сеть клиента (обычно это не требуется для VPN, но имейте в виду). Не является стандартом WireGuard.
    * **Когда использовать:** Рекомендуется по умолчанию для повышения шансов обхода блокировок.

3.  **Режим 3: Пользовательский (Split-Tunneling)**
    * **Описание:** Через VPN будет идти только трафик, предназначенный для сетей, указанных вами при установке (или через CLI/команду `modify`).
    * **Плюсы:** Позволяет одновременно иметь доступ к локальным ресурсам и к удаленным ресурсам через VPN. Экономит трафик VPN.
    * **Минусы:** Весь остальной трафик идет напрямую, без защиты VPN. Требует точного указания нужных сетей.
    * **Когда использовать:** Для доступа к корпоративным сетям, домашней сети или специфическим ресурсам, оставляя остальной трафик идти напрямую.
    * **Пример значения:** `192.168.1.0/24, 10.50.0.0/16`

> **Важно:** Скрипт **не поддерживает** исключение трафика к конкретным **доменам** (например, `*.ru`) из туннеля через `AllowedIPs`. Это требует более сложных механизмов маршрутизации на клиенте.

### PersistentKeepalive

* **Значение по умолчанию:** `33` (секунды)
* **Описание:** Заставляет клиента периодически отправлять пустой пакет серверу для поддержания UDP-сессии через NAT и фаерволы.
* **Рекомендация:** Значение `25-35` обычно является хорошим компромиссом.
* **Изменение:** Используйте команду `modify` скрипта управления:
    ```bash
    sudo bash /root/awg/manage_amneziawg.sh modify <имя_клиента> PersistentKeepalive 25
    ```

### DNS

* **Значение по умолчанию:** `1.1.1.1` (Cloudflare)
* **Описание:** DNS-сервер, который будет использоваться клиентом при активном VPN-соединении.
* **Рекомендация:** `1.1.1.1` - быстрый и приватный. Другие опции: `8.8.8.8` (Google), `9.9.9.9` (Quad9). Можно указать несколько через запятую: `1.1.1.1, 8.8.8.8`.
* **Изменение:** Используйте команду `modify` скрипта управления:
    ```bash
    sudo bash /root/awg/manage_amneziawg.sh modify <имя_клиента> DNS "8.8.8.8, 1.0.0.1"
    ```

### Изменение настроек по умолчанию

Если вы хотите изменить значения **по умолчанию** (которые будут применяться ко всем *новым* клиентам), вам нужно отредактировать сам скрипт **`install_amneziawg.sh`** *перед* его первым запуском (или перед выполнением Шага 6 установки):

1.  Откройте `install_amneziawg.sh` в текстовом редакторе.
2.  Найдите функцию `step6_generate_configs`.
3.  Найдите строки с командами `sed` для параметров `DNS`, `PersistentKeepalive`, `AllowedIPs`.
4.  Измените значения в этих командах `sed` на желаемые.
5.  Сохраните скрипт и запустите установку.

---

## Настройки безопасности сервера

Скрипт установки применяет ряд мер для повышения безопасности сервера.

### Фаервол UFW

* **Политики:** Запретить весь входящий трафик, разрешить весь исходящий.
* **Разрешенные порты:**
    * `22/tcp` (SSH) с **ограничением частоты** подключений (`limit`) для защиты от брутфорса.
    * `ВАШ_ПОРТ/udp` (выбранный для AmneziaWG).
* **Включение:** UFW включается и настраивается на автозапуск. Скрипт выводит **предупреждение** перед включением, чтобы вы убедились в наличии правила для вашего порта SSH.
* **Проверка:** `sudo ufw status verbose`

### Параметры ядра (Sysctl)

Применяются через файл `/etc/sysctl.d/99-amneziawg-security.conf`:

* **IP Forwarding:** `net.ipv4.ip_forward = 1` (включено).
* **Отключение IPv6 (если выбрано):** `net.ipv6.conf.*.disable_ipv6 = 1`.
* **Защита от IP-спуфинга:** `rp_filter = 1`.
* **Игнорирование ICMP:** `icmp_echo_ignore_broadcasts = 1`, `icmp_ignore_bogus_error_responses = 1`.
* **Оптимизация TCP/IP:** `fq` (очередь), `bbr` (контроль перегрузки).
* **Защита от SYN-флуда:** `tcp_syncookies = 1` и др.
* **Отключение ICMP Redirect:** `accept_redirects = 0`, `secure_redirects = 0`.

### Fail2Ban (Ручная установка)

Скрипт установки больше **не устанавливает** Fail2Ban автоматически из-за выявленных ранее конфликтов. Однако, настоятельно рекомендуется установить его вручную для защиты SSH от брутфорс-атак.

**Инструкция по ручной установке:**

1.  **Установите пакет:**
    ```bash
    sudo apt update
    sudo apt install fail2ban
    ```
2.  **Создайте локальный конфигурационный файл:**
    ```bash
    sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
    ```
3.  **Отредактируйте `/etc/fail2ban/jail.local`:**
    ```bash
    sudo nano /etc/fail2ban/jail.local
    ```
    Найдите секцию `[sshd]`. Убедитесь, что `enabled = true`. Вы можете изменить `bantime`, `findtime`, `maxretry` по своему усмотрению. Важно, чтобы `banaction` соответствовал вашему фаерволу (по умолчанию скрипт ставит `ufw`).
    ```ini
    [sshd]
    enabled = true
    # port    = ssh # Раскомментируйте и измените, если у вас нестандартный порт
    # banaction = ufw # Должно быть здесь или в [DEFAULT]
    maxretry = 3    # Например, банить после 3 неудачных попыток
    bantime  = 12h  # Например, банить на 12 часов
    ```
4.  **Перезапустите Fail2Ban:**
    ```bash
    sudo systemctl restart fail2ban
    ```
5.  **Проверьте статус:**
    ```bash
    sudo fail2ban-client status
    sudo fail2ban-client status sshd
    ```

---

## Автоматизация обслуживания

Скрипт установки настраивает следующие задачи автоматизации:

### Резервное копирование

* **Что:** Ежедневно создается `.tar.gz` архив, содержащий `/etc/amnezia/amneziawg/` (конфиг сервера), `/root/awg/*.conf`, `/root/awg/*.png`, `/root/awg/setup.conf`.
* **Куда:** `/root/awg/backups/`.
* **Когда:** Каждый день в 3:00 ночи (см. `/etc/cron.d/backup_amneziawg`).
* **Ротация:** Хранятся 10 последних копий.
* **Скрипт:** `/usr/local/bin/backup_amneziawg.sh`.
* **Лог:** `/root/awg/backups/backup.log`.
* **Ручной запуск:** `sudo bash /root/awg/manage_amneziawg.sh backup`.
* **Восстановление:** `sudo bash /root/awg/manage_amneziawg.sh restore [файл]`.

### Автоматические обновления

* **Что:** Настраивается `unattended-upgrades` для автоматической установки **обновлений безопасности**.
* **Конфигурация:** `/etc/apt/apt.conf.d/20auto-upgrades`. Включено удаление старых ядер и зависимостей. Автоматическая перезагрузка **отключена**.

### Ротация логов

* **Что:** Настраивается `logrotate` для логов скриптов установки, управления и бэкапов.
* **Конфигурация:** `/etc/logrotate.d/amneziawg-installer`.
* **Когда:** Еженедельно, хранятся 12 ротированных логов.

---

## Параметры запуска скриптов

### install_amneziawg.sh

```
Использование: install_amneziawg.sh [ОПЦИИ]

Опции:
  -h, --help            Показать справку
  --uninstall           Удалить AmneziaWG
  --diagnostic          Создать диагностический отчет
  -v, --verbose         Расширенный вывод
  --port=НОМЕР          Установить UDP порт (1024-65535) неинтерактивно
  --subnet=ПОДСЕТЬ      Установить подсеть туннеля (x.x.x.x/yy) неинтерактивно
  --allow-ipv6          Оставить IPv6 включенным неинтерактивно
  --disallow-ipv6       Принудительно отключить IPv6 неинтерактивно
  --route-all           Использовать режим 'Весь трафик' неинтерактивно
  --route-amnezia       Использовать режим 'Amnezia' неинтерактивно
  --route-custom=СЕТИ   Использовать режим 'Пользовательский' неинтерактивно
```

### manage_amneziawg.sh

```
Использование: manage_amneziawg.sh [ОПЦИИ] <КОМАНДА> [АРГУМЕНТЫ]

Опции:
  -h, --help            Показать справку
  -v, --verbose         Расширенный вывод (для команды list)
  --conf-dir=ПУТЬ       Указать директорию AWG (по умолч: /root/awg)
  --server-conf=ПУТЬ    Указать файл конфига сервера (по умолч: /etc/amnezia/amneziawg/awg0.conf)

Команды: (см. help для полного списка)
  add <имя>, remove <имя>, list [-v], regen [имя], modify <имя> <пар> <зн>,
  backup, restore [файл], check | status, show, restart, help
```

---

## Полный список команд управления

Скрипт `manage_amneziawg.sh` предоставляет следующие команды:

* **`add <имя_клиента>`:** Добавляет нового клиента. Требует перезапуска сервиса.
* **`remove <имя_клиента>`:** Удаляет клиента. Требует перезапуска сервиса.
* **`list [-v | --verbose]`:** Показывает список клиентов. С флагом `-v` выводит IP, начало ключа и статус активности (Активен / Недавно / Нет handshake / Не найден / ошибка ключа).
* **`regen [имя_клиента]`:** Перегенерирует файлы `.conf` и `.png` для указанного клиента или для **всех**, если имя не указано (ключи не меняются).
* **`modify <имя> <параметр> <значение>`:** Изменяет указанный `<параметр>` (например, `DNS`, `PersistentKeepalive`, `AllowedIPs`) на `<значение>` в файле `/root/awg/<имя>.conf`. Создает бэкап файла перед изменением. Перегенерирует QR-код, если изменен важный параметр.
* **`backup`:** Создает резервную копию конфигураций сервера и клиентов в `/root/awg/backups/`, сохраняя 10 последних копий.
* **`restore [путь_к_бэкапу]`:** Восстанавливает конфигурацию из указанного файла бэкапа или предлагает выбрать из последних 10, если путь не указан. Требует подтверждения и перезапуска сервиса. Создает бэкап текущей конфигурации перед восстановлением.
* **`check` / `status`:** Выполняет комплексную проверку состояния сервера (статус сервиса systemd, наличие интерфейса awg0, прослушивание порта, IP forwarding, правило UFW, вывод `awg show`).
* **`show`:** Выполняет команду `awg show` для отображения текущего статуса пиров.
* **`restart`:** Перезапускает сервис `awg-quick@awg0` (с запросом подтверждения).
* **`help`:** Показывает справку по командам и опциям.

---

## Технические детали

* **DKMS:** Используется для автоматической пересборки модуля ядра `amneziawg` при обновлении системного ядра. Логи сборки: `/var/lib/dkms/amneziawg/`.
* **Python Venv:** Скрипт `awgcfg.py` и его зависимости (`qrcode`, `pillow`) находятся в изолированном окружении `/root/awg/venv`.
* **awgcfg.py:** Вспомогательный скрипт для генерации ключей, конфигов и QR-кодов.

---

## Диагностика и деинсталляция

* **Диагностика:** `sudo bash /путь/к/install_amneziawg.sh --diagnostic`. Отчет будет сохранен в `/root/awg/diag_*.txt`.
* **Деинсталляция:** `sudo bash /путь/к/install_amneziawg.sh --uninstall`. Запросит подтверждение и предложит создать бэкап.

---

## Внесение вклада (Contributing)

Предложения по улучшению, исправления ошибок и новый функционал приветствуются! Пожалуйста, создавайте Issue для обсуждения или Pull Request с вашими изменениями в [основном репозитории](https://github.com/bivlked/amneziawg-installer).

---

## Благодарности

* Команде [Amnezia VPN](https://github.com/amnezia-vpn) за AmneziaWG.
* Пользователю [remittor](https://gist.github.com/remittor) за основу утилиты `awgcfg.py`.

---

<p align="center">
  <a href="#amneziawg-installer-дополнительная-информация-и-настройки">↑ К началу</a>
</p>
