![Ubuntu 24.04](https://img.shields.io/badge/Ubuntu-24.04-orange)
![License](https://img.shields.io/badge/License-MIT-blue)
![Status](https://img.shields.io/badge/Status-Active-success)
![Version](https://img.shields.io/badge/Version-1.1-brightgreen)

# Руководство по установке и управлению AmneziaWG с помощью скриптов

## Введение

Это руководство описывает процесс установки VPN-сервера AmneziaWG на чистую систему Ubuntu Server 24.04 LTS Minimal, а также последующее управление пользователями (пирами) с использованием предоставленных скриптов (`install_amneziawg.sh` и `manage_amneziawg.sh`).

Скрипты автоматизируют большинство шагов, включая обновление системы, установку зависимостей, настройку ядра, конфигурацию фаервола и генерацию файлов AmneziaWG. Они разработаны для минимизации ручного вмешательства и повышения надежности установки, а также включают автоматическую кастомизацию генерируемых конфигураций клиентов.

**Целевая аудитория:** Администраторы с базовыми знаниями командной строки Linux.

**Тестировалось на:** Ubuntu Server 24.04.2 LTS Minimal (рекомендуется использовать именно эту или совместимую версию).

## 1. Первоначальная подготовка системы

Перед запуском скрипта установки убедитесь, что выполнены следующие условия:

1.  **Чистая ОС:** У вас установлена свежая Ubuntu Server 24.04 LTS Minimal. Наличие других веб-серверов, панелей управления или сложных сетевых конфигураций может вызвать конфликты.
2.  **Доступ Root:** У вас есть доступ к серверу с правами root (через пользователя с `sudo` или прямой логин root). Все команды скриптов нужно будет выполнять через `sudo` или из сессии root (`sudo su -`).
3.  **Интернет:** Сервер имеет стабильное подключение к Интернету для скачивания пакетов и обновлений.
4.  **Ресурсы:** Достаточно свободного места на диске (рекомендуется > 2 ГБ для системы, зависимостей и логов) и оперативной памяти (рекомендуется > 512 МБ).
5.  **SSH Доступ:** Вы можете подключаться к серверу по SSH. **Критически важно:** Убедитесь, что ваш SSH доступ не будет заблокирован фаерволом после его настройки (скрипт по умолчанию разрешает стандартный порт 22/tcp). Если у вас SSH на другом порту, вам нужно будет *до* запуска Шага 4 скрипта (настройка UFW) вручную добавить правило `sudo ufw allow ВАШ_ПОРТ/tcp` или модифицировать скрипт. Скрипт установки выполняет проверку на наличие правила для порта 22 перед включением UFW.

## 2. Установка AmneziaWG (скрипт `install_amneziawg.sh`)

Этот скрипт выполняет полную установку и настройку сервера. Он идемпотентен, то есть его можно безопасно запускать повторно (например, после необходимой перезагрузки) - он продолжит работу с того места, где остановился.

**Шаги:**

1.  **Скачайте и запустите скрипт ОДНОЙ КОМАНДОЙ:**
    Подключитесь к вашему серверу по SSH и выполните следующую команду. Она скачает скрипт установки и немедленно запустит его с правами `sudo`. Замените `<URL_СКРИПТА>` на реальный URL к файлу `install_amneziawg.sh` на GitHub (или другом источнике).

    ```bash
    wget -O - <URL_СКРИПТА>/install_amneziawg.sh | sudo bash
    ```
    *Пример URL для GitHub (замените `bivlked/amneziawg-installer` и `main` при необходимости):*
    ```bash
    wget -O - https://raw.githubusercontent.com/bivlked/amneziawg-installer/main/install_amneziawg.sh | sudo bash
    ```
    *Примечание:* Использование `wget | sudo bash` является распространенным способом установки, но несет риски, если вы не доверяете источнику скрипта. Всегда проверяйте URL перед выполнением. **Никогда не используйте `curl | sudo bash` для скриптов из недоверенных источников!**

2.  **Следуйте инструкциям на экране:**
    *   **Настройка порта и подсети:** При первом запуске скрипт запросит у вас UDP порт для AmneziaWG и внутреннюю подсеть. Нажмите Enter для использования значений по умолчанию (порт 39743, подсеть 10.9.9.1/24) или введите свои. Настройки сохранятся в `~/awg/setup.conf`.
    *   **Перезагрузки:** Скрипт потребует **две** перезагрузки. Он обнаружит необходимость, выведет **ЗАМЕТНОЕ** предупреждение и запросит подтверждение (`Перезагрузить сейчас? [y/N]:`). Введите `y` для перезагрузки.
    *   **Продолжение после перезагрузки:** **ВАЖНО!** После каждой перезагрузки **снова запустите ту же самую команду**, что и в п.1:
        ```bash
        wget -O - <URL_СКРИПТА>/install_amneziawg.sh | sudo bash
        ```
        Скрипт автоматически определит, с какого шага продолжить.

3.  **Завершение установки:** После успешного выполнения всех шагов скрипт выведет сообщение о завершении, список полезных команд и напомнит о клиентских файлах. Файл состояния `~/awg/setup_state` будет удален. Лог установки находится в `~/awg/install_amneziawg.log`.

**Автоматическая кастомизация клиентских конфигураций:**

Скрипт установки автоматически настраивает генерируемые файлы конфигурации клиентов (`*.conf`) следующим образом:

*   **`DNS = 1.1.1.1`**: Используется DNS-сервер Cloudflare.
*   **`PersistentKeepalive = 33`**: Устанавливается интервал отправки keepalive-пакетов для поддержания соединения через NAT.
*   **`AllowedIPs = 0.0.0.0/5, ..., 8.8.8.8/32, 1.1.1.1/32`**: Используется специфичный набор диапазонов IP-адресов, предложенный разработчиками AmneziaWG (предположительно для улучшения совместимости или обхода блокировок), с добавлением явных маршрутов для DNS-серверов Google и Cloudflare для гарантии их работы через туннель. Этот набор **не исключает** локальные сети клиента (LAN).

**Пояснение к `AllowedIPs`:**

В отличие от стандартного `AllowedIPs = 0.0.0.0/0` (который направляет абсолютно весь IPv4 трафик в туннель), используемый по умолчанию список Amnezia является более сложным.

*   **Цель (предположительно):** Возможно, такой список помогает обходить простые системы DPI, которые ищут правило "весь трафик в VPN", или решает какие-то специфичные проблемы маршрутизации.
*   **Включение DNS:** Добавление `8.8.8.8/32` и `1.1.1.1/32` гарантирует, что DNS-запросы к этим популярным серверам пойдут через туннель, даже если другие правила маршрутизации попытаются их отправить иначе.
*   **Исключение локальных сетей:** Этот список **не** предназначен для исключения доступа к локальной сети клиента (split-tunneling для LAN). Трафик в локальные сети (например, 192.168.1.0/24) будет пытаться уйти в туннель, так как он покрывается широкими диапазонами в списке.
*   **Исключение специфичных сайтов (например, *.ru):** Скрипт **не пытается** исключить трафик к определенным веб-сайтам (вроде госуслуг) из туннеля. Это связано со сложностью и ненадежностью отслеживания их IP-адресов. Если вам необходим такой "split-tunneling", вам потребуется настроить его вручную на стороне клиента или сервера с помощью системных маршрутов или более сложных правил фаервола, что выходит за рамки данного скрипта. Вы также можете вручную отредактировать параметр `AllowedIPs` в файле клиента `.conf` *после* его генерации, заменив длинный список на `0.0.0.0/0` или другой необходимый вам набор сетей.

## 3. Управление пользователями (скрипт `manage_amneziawg.sh`)

Используйте этот скрипт для повседневного управления клиентами после завершения установки.

**Шаги:**

1.  **Скачайте скрипт (если не сделали ранее):**
    ```bash
    # Замените URL на актуальный
    wget -O manage_amneziawg.sh <URL_СКРИПТА>/manage_amneziawg.sh
    chmod +x manage_amneziawg.sh
    ```
    Рекомендуется поместить его в `~/awg`.

2.  **Используйте скрипт с правами root:**
    ```bash
    sudo bash ./manage_amneziawg.sh <команда> [аргументы]
    ```
    (Или `sudo bash ~/awg/manage_amneziawg.sh ...` если вы не в директории `~/awg`).

**Доступные команды:**

*   **`add <имя_клиента>`:** Добавляет нового клиента.
    *   *Пример:* `sudo bash ./manage_amneziawg.sh add work-pc`
    *   Создаст файлы `work-pc.conf` и `work-pc.png` в `~/awg`.
    *   **Требуется перезапуск сервиса:** `sudo systemctl restart awg-quick@awg0`

*   **`remove <имя_клиента>`:** Удаляет клиента.
    *   *Пример:* `sudo bash ./manage_amneziawg.sh remove old-phone`
    *   Удалит клиента из конфигурации сервера и его файлы из `~/awg`.
    *   **Требуется перезапуск сервиса:** `sudo systemctl restart awg-quick@awg0`

*   **`list`:** Показывает список настроенных клиентов.
    *   *Пример:* `sudo bash ./manage_amneziawg.sh list`

*   **`regen [имя_клиента]`:** Перегенерирует `.conf` и `.png` файлы. Без имени - для всех клиентов.
    *   *Пример (для одного):* `sudo bash ./manage_amneziawg.sh regen my_laptop`
    *   *Пример (для всех):* `sudo bash ./manage_amneziawg.sh regen`

*   **`show`:** Показывает текущий статус AmneziaWG (`awg show`).
    *   *Пример:* `sudo bash ./manage_amneziawg.sh show`

*   **`help`:** Показывает справку.

**Расположение файлов клиентов:** `~/awg` (обычно `/root/awg`).

## 4. Принципы, инструменты и детали

*   **Идемпотентность и Возобновляемость:** Скрипт установки можно безопасно запускать повторно.
*   **Состояние и Конфигурация:** Используются файлы `~/awg/setup_state` и `~/awg/setup.conf`.
*   **Автоматизация:** Включение `deb-src`, настройка UFW, кастомизация шаблона клиента.
*   **Безопасность:** UFW deny-by-default, права `chmod 600` на ключи, отключение IPv6.
*   **Инструменты:** `apt`, `systemctl`, `sysctl`, `ufw`, `modprobe`, `python3/venv/pip`, `wget`, `sed`, `awgcfg.py`, `awg`, `awg-quick`.
*   **Логирование:** Основные действия записываются в `~/awg/install_amneziawg.log` и `~/awg/manage_amneziawg.log`.

**Отказ от ответственности:** Скрипты предоставляются "как есть". Тестируйте перед использованием на важных системах. Делайте резервные копии.
